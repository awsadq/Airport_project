<!DOCTYPE html>
<html lang="ru" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–ª–µ—Ç–∞</title>
    <link rel="stylesheet" href="project_css/booking.css">

</head>
<body>

<nav class="navbar">
    <div class="navbar-container">
        <a class="navbar-brand" href="/" th:href="@{/}">Airport Travel</a>

        <ul class="navbar-menu">
            <li><a href="/flights">–†–µ–π—Å—ã</a></li>
            <li><a href="/booking">–ë—Ä–æ–Ω—å –±–∏–ª–µ—Ç–æ–≤</a></li>
            <li><a href="/services">–£—Å–ª—É–≥–∏</a></li>
            <li><a href="/profile">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></li>
        </ul>

        <ul class="navbar-right">
            <li sec:authorize="isAuthenticated()">
                <a href="#" onclick="confirmLogout()" class="btn-logout">–í—ã–π—Ç–∏</a>
            </li>
        </ul>
    </div>
</nav>

<header>
    <h1>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–ª–µ—Ç–æ–≤</h1>
</header>

<div class="container">
    <h2>–§–æ—Ä–º–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
    <form id="bookingForm">
        <label for="passengerName">–§–ò–û –ø–∞—Å—Å–∞–∂–∏—Ä–∞:</label>
        <input type="text" id="passengerName" name="passengerName" required>

        <label for="passportNumber">–ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞:</label>
        <input type="text" id="passportNumber" name="passportNumber" required>

        <label for="flight">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–π—Å:</label>
        <select id="flight" name="flightId" required>
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Å–æ–≤...</option>
        </select>

        <label for="seatNumber">–ù–æ–º–µ—Ä –º–µ—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, A1):</label>
        <input type="text" id="seatNumber" name="seatNumber">

        <button type="submit">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
    </form>

    <div id="result"></div>
</div>

<div id="flightInfo" style="
    margin: 20px auto;
    padding: 15px;
    border: 1px solid #cceeff;
    border-radius: 8px;
    background: #f3faff;
    width: 400px;
    text-align: left;
    display: none;">
    <p><strong>‚úàÔ∏è –†–µ–π—Å:</strong> <span id="infoNumber"></span></p>
    <p><strong>üõ´ –û—Ç–∫—É–¥–∞:</strong> <span id="infoFrom"></span></p>
    <p><strong>üõ¨ –ö—É–¥–∞:</strong> <span id="infoTo"></span></p>
    <p><strong>üïí –í—ã–ª–µ—Ç:</strong> <span id="infoDeparture"></span></p>
    <p><strong>‚è≥ –î–æ –≤—ã–ª–µ—Ç–∞:</strong> <span id="infoCountdown"></span></p>
</div>


<div class="checkin-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Ä–µ–π—Å</div>

<form id="checkInForm">
    <label for="bookingId">–ù–æ–º–µ—Ä –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
    <input type="number" id="bookingId" name="bookingId" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä, –≤—ã–¥–∞–Ω–Ω—ã–π –ø–æ—Å–ª–µ –±—Ä–æ–Ω–∏">
    <small>–ù–∞–π—Ç–∏ –º–æ–∂–Ω–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –±—Ä–æ–Ω–∏ –≤—ã—à–µ üëÜ</small>

    <label>
        <input type="checkbox" id="baggageStatus" name="baggageStatus">
        –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –±–∞–≥–∞–∂
    </label>

    <button type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>

    <div id="checkInResult"></div>

</form>

<footer class="footer">
    <div class="footer-container">
        <div class="footer-left">
            <h2 class="footer-title">Airport Travel</h2>
            <p class="footer-description">
                –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à —Ü–∏—Ñ—Ä–æ–≤–æ–π –∞—ç—Ä–æ–ø–æ—Ä—Ç! –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å, –∫–æ–º—Ñ–æ—Ä—Ç<br>
                –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.
            </p>
        </div>
        <div class="footer-right">
            <ul class="footer-menu">
                <li><a href="/flights">‚úàÔ∏è –†–µ–π—Å—ã</a></li>
                <li><a href="/booking">üìÑ –ë—Ä–æ–Ω—å –±–∏–ª–µ—Ç–æ–≤</a></li>
                <li><a href="/services">üõ†Ô∏è –£—Å–ª—É–≥–∏</a></li>
                <li><a href="/profile">üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></li>
            </ul>
        </div>
    </div>
    <hr class="footer-divider">
    <div class="footer-bottom">
        ¬© <?= date("Y") ?> Airport Travel. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.
    </div>
</footer>


<script>
    document.getElementById('checkInForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const bookingId = document.getElementById('bookingId').value.trim();
        const baggageStatus = document.getElementById('baggageStatus').checked;
        const result = document.getElementById('checkInResult');

        result.innerText = '';
        result.style.color = '';

        if (!bookingId || isNaN(bookingId) || bookingId <= 0) {
            result.innerText = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è!';
            result.style.color = 'red';
            return;
        }

        const payload = { bookingId: Number(bookingId), baggageStatus };

        // –ü—Ä–æ–±—É–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
        try {
            const res = await fetch('/api/check-in', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const pdfUrl = `/api/check-in/${bookingId}/boarding-pass`;

            if (res.ok) {
                result.innerText = '‚úÖ –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã! –í–∞—à —Ç–∞–ª–æ–Ω —Å–µ–π—á–∞—Å —Å–∫–∞—á–∞–µ—Ç—Å—è.';
                result.style.color = 'green';

                await downloadPdf(pdfUrl);
            } else {
                const errorText = await res.text();

                if (errorText.includes("—É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")) {
                    result.innerText = '‚ÑπÔ∏è –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–∞–¥–æ—á–Ω—ã–π —Ç–∞–ª–æ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ...';
                    result.style.color = 'blue';

                    await downloadPdf(pdfUrl);
                } else {
                    result.innerText = '‚ùå –û—à–∏–±–∫–∞: ' + errorText;
                    result.style.color = 'red';
                }
            }
        } catch (err) {
            console.error("–û—à–∏–±–∫–∞:", err);
            result.innerText = '‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.';
            result.style.color = 'red';
        }
    });

    async function downloadPdf(pdfUrl) {
        try {
            const response = await fetch(pdfUrl);
            if (!response.ok) throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Å–∞–¥–æ—á–Ω—ã–π —Ç–∞–ª–æ–Ω.");

            const blob = await response.blob();
            const blobUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = 'boarding-pass.pdf';
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(blobUrl);
        } catch (err) {
            const result = document.getElementById('checkInResult');
            result.innerText = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ PDF: ' + err.message;
            result.style.color = 'red';
        }
    }
</script>


<script>
    const flightsMap = new Map();
    const flightSelect = document.getElementById('flight');

    fetch('/api/flights')
        .then(res => res.json())
        .then(data => {
            console.log("üì• –°–ø–∏—Å–æ–∫ —Ä–µ–π—Å–æ–≤:", data);
            flightSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–π—Å...</option>';

            data.forEach(flight => {
                flightsMap.set(flight.id, flight);

                const option = document.createElement('option');
                option.value = flight.id;
                option.text = `${flight.flightNumber} | ${flight.departureAirport} ‚Üí ${flight.arrivalAirport} | ${flight.departureTime}`;
                flightSelect.appendChild(option);
            });

            // ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ä–µ–π—Å–∞
            flightSelect.addEventListener('change', () => {
                const selectedId = Number(flightSelect.value);
                const flight = flightsMap.get(selectedId);
                const infoBlock = document.getElementById('flightInfo');

                if (!flight) {
                    infoBlock.style.display = 'none';
                    return;
                }

                document.getElementById('infoNumber').innerText = flight.flightNumber;
                document.getElementById('infoFrom').innerText = flight.departureAirport;
                document.getElementById('infoTo').innerText = flight.arrivalAirport;

                const departureTime = flight.departureTime; // "15:10"
                const departureDateStr = flight.departureDate; // "2025-03-22"

                const fullDateTimeStr = `${departureDateStr}T${departureTime}`;
                const departureDate = new Date(fullDateTimeStr);

                if (isNaN(departureDate.getTime())) {
                    document.getElementById('infoDeparture').innerText = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã';
                    document.getElementById('infoCountdown').innerText = '‚Äî';
                    infoBlock.style.display = 'block';
                    return;
                }

                // –ü–æ–∫–∞–∑ –¥–∞—Ç—ã –≤ —á–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                const formattedDate = departureDate.toLocaleString('ru-RU', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                document.getElementById('infoDeparture').innerText = formattedDate;

                const countdownSpan = document.getElementById('infoCountdown');
                const targetTime = departureDate.getTime();

                clearInterval(window.departureTimer);
                function updateCountdown() {
                    const now = new Date().getTime();
                    const diff = targetTime - now;

                    if (diff <= 0) {
                        countdownSpan.innerText = "‚úÖ –†–µ–π—Å –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è";
                        clearInterval(window.departureTimer);
                    } else {
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        countdownSpan.innerText = `${hours} —á ${minutes} –º–∏–Ω`;
                    }
                }

                updateCountdown();
                window.departureTimer = setInterval(updateCountdown, 1000);

                infoBlock.style.display = 'block';
            });

        })
        .catch(error => {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Å–æ–≤:", error);
            document.getElementById('result').innerText = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–π—Å—ã.';
            document.getElementById('result').style.color = 'red';
        });


    // üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('bookingForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const passengerName = document.getElementById('passengerName').value.trim();
        const passportNumber = document.getElementById('passportNumber').value.trim();
        const flightIdStr = document.getElementById('flight').value.trim();
        const seatNumber = document.getElementById('seatNumber').value.trim();

        if (!passengerName || !passportNumber || !flightIdStr) {
            alert("‚ùå –í—Å–µ –ø–æ–ª—è (–∫—Ä–æ–º–µ –º–µ—Å—Ç–∞) –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã!");
            return;
        }

        const flightId = Number(flightIdStr);
        if (isNaN(flightId) || flightId <= 0) {
            alert("‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–µ–π—Å–∞!");
            return;
        }

        const payload = {
            passengerName,
            passportNumber,
            flightId,
            seatNumber
        };

        console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ:", payload);

        try {
            const response = await fetch('/api/bookings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(payload)
            });

            const result = document.getElementById('result');
            if (response.ok) {
                const data = await response.text(); // ‚Üê —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å ID –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
                result.style.color = 'green';
                result.innerText = `‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!\n–í–∞—à –Ω–æ–º–µ—Ä –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${data}`;
            } else {
                const err = await response.text();
                result.style.color = 'red';
                result.innerText = '‚ùå –û—à–∏–±–∫–∞: ' + err;
            }
        } catch (error) {
            console.error("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error);
            document.getElementById('result').style.color = 'red';
            document.getElementById('result').innerText = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error;
        }
    });
</script>


</body>
</html>
